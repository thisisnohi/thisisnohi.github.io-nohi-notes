(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{246:function(e,a,s){"use strict";s.r(a);var n=s(5),t=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("div",{staticClass:"content"},[s("h1",{attrs:{id:"oracle-常用脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#oracle-常用脚本","aria-hidden":"true"}},[e._v("#")]),e._v(" Oracle 常用脚本")]),e._v(" "),s("blockquote",[s("p",[e._v("ceate by nohi 20201230")])]),e._v(" "),s("h2",{attrs:{id:"锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#锁","aria-hidden":"true"}},[e._v("#")]),e._v(" 锁")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("-- 锁       \nSELECT /*+ rule */ s.username, decode(l.type,'TM','TABLE LOCK','TX','ROW LOCK',\nNULL) LOCK_LEVEL, o.owner,o.object_name,o.object_type,\ns.sid,s.serial#,s.terminal,s.machine,s.program,s.osuser\nFROM v$session s,v$lock l,dba_objects o\nWHERE l.sid = s.sid\nAND l.id1 = o.object_id(+)\nand l.type in ('TM','TX')\nAND s.username is NOT NULL\nand s.username in ('','CURVAPP','');\n\n-- 杀进程\nALTER SYSTEM KILL SESSION '619, 14479';\n\nSELECT 'ALTER SYSTEM KILL SESSION '''  || s.sid || ',' || s.serial# || ''';'\nFROM v$session s,v$lock l,dba_objects o\nWHERE l.sid = s.sid\nAND l.id1 = o.object_id(+)\nAND s.username is NOT NULL\nand s.username in ('','CURVAPP','')\nand l.type in ('TM','TX');\n")])])]),s("h2",{attrs:{id:"表空间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#表空间","aria-hidden":"true"}},[e._v("#")]),e._v(" 表空间")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('-- 修改表所属表空间：alter table 表名 move tablespace "表空间名称"\n-- 修改表索引所属表空间：alter index 索引名 rebuild tablespace "表空间名称"\n\n-- 查询某表空间的所有表：\nselect segment_name from dba_segments where owner=\'表空间名称\' and segment_type=\'TABLE\' group by segment_name\n\n-- 查询用户占用空间大小\nselect owner,tablespace_name,round(sum(bytes)/1024/1024,2) "USED (M)" from dba_segments \ngroup by owner,tablespace_name\norder by sum(bytes)desc;\n\n-- 临时表空间   \nselect tablespace_name,file_name,bytes/1024/1024 file_size,autoextensible from dba_temp_files;\n\n-- 临时表空间\nSELECT D.TABLESPACE_NAME,SPACE "SUM_SPACE(M)",BLOCKS SUM_BLOCKS,\nUSED_SPACE "USED_SPACE(M)",ROUND(NVL(USED_SPACE,0)/SPACE*100,2) "USED_RATE(%)",\nNVL(FREE_SPACE,0) "FREE_SPACE(M)"\nFROM\n(SELECT TABLESPACE_NAME,ROUND(SUM(BYTES)/(1024*1024),2) SPACE,SUM(BLOCKS) BLOCKS\nFROM DBA_TEMP_FILES\nGROUP BY TABLESPACE_NAME) D,\n(SELECT TABLESPACE_NAME,ROUND(SUM(BYTES_USED)/(1024*1024),2) USED_SPACE,\nROUND(SUM(BYTES_FREE)/(1024*1024),2) FREE_SPACE\nFROM V$TEMP_SPACE_HEADER\nGROUP BY TABLESPACE_NAME) F\nWHERE  D.TABLESPACE_NAME = F.TABLESPACE_NAME(+);\n\nalter database tempfile \'+BJXG_CS_CBPC_DATA/APPDB/TEMPFILE/temp.370.1021910773\' resize 30G;\n')])])]),s("h2",{attrs:{id:"创建表空间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建表空间","aria-hidden":"true"}},[e._v("#")]),e._v(" 创建表空间")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("-- 查询表空间路径\nselect * from dba_data_files; \n-- 创建表空间\ncreate tablespace jcms\ndatafile '/opt/oracle/app/oradata/orcl/jcms.dbf'\nsize 10M reuse autoextend on;\n-- 创建临时表空间\ncreate tablespace ocrm\ndatafile '/home/oracle/app/oracle/oradata/orcl/ocrm.dbf'\nsize 10M reuse autoextend on;\n")])])]),s("h2",{attrs:{id:"用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用户","aria-hidden":"true"}},[e._v("#")]),e._v(" 用户")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("drop user xetl cascade;\nDROP TABLESPACE newoa INCLUDING CONTENTS AND DATAFILES;\ndrop table CHANNELCODE cascade constraints;\n\n-- 12c 数据 切换seesion\nselect * from V$ACCESS;\nselect name,cdb from v$database;\nselect pdb_id,pdb_name,dbid,status,creation_scn from dba_pdbs;\nselect con_id,dbid,NAME,OPEN_MODE from v$pdbs;\n\nalter session set container=ORCLPDB1;\nalter session set container = cdb$root;\n\nalter pluggable database ORCLPDB1 open;\n\n-- 创建用户\n create user jcms\n identified by jcms\n default tablespace jcms\n account unlock;\n-- 赋权 \n grant create session to xetl;\n grant create table to xetl;\n grant create sequence to xetl;\n grant create procedure to xetl;\n grant create VIEW to xetl;\n grant resource to xetl;\n \nalter user pi_valuation account  unlock;\nrevoke dba from cap;\ngrant dba to jcms;\n")])])]),s("h2",{attrs:{id:"导入导出"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#导入导出","aria-hidden":"true"}},[e._v("#")]),e._v(" 导入导出")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("exp、imp")]),e._v(" "),s("ul",[s("li",[e._v("exp userid=sap/sap@orcl_sit  owner=sap file=sap_sit_20121206.dmp log=sap.log")]),e._v(" "),s("li",[e._v("exp userid=sap/sap@orcl_sit  owner=sap file=sap_sit_20121206.dmp log=sap.log tables=T_USER,T_ROLE")]),e._v(" "),s("li",[e._v("imp newoa1203/newoa1203@nohi file=sap_sit_20121206.dmp fromuser=sap touser=sap_uat")]),e._v(" "),s("li",[e._v("imp newoa1203/newoa1203@nohi file=sap_sit_20121206.dmp fromuser=sap touser=sap_uat  tables=T_USER,T_ROLE")]),e._v(" "),s("li",[e._v("增加buffer\nimp esb_tmp/esb_tmp file=sap_sit_20121206 log=imp tables=T_USER ignore=yes buffer=102400000    commit=yes feedback=1000")]),e._v(" "),s("li",[e._v("导出表结构 exp ocrm/ocrm@43_227 file=ocrm_t.dmp owner=(ocrm) rows=n")])])]),e._v(" "),s("li",[s("p",[e._v("数据泵方式")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("创建目录")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("select * from dba_directories;\n -- 创建目录\ncreate or replace directory data_dump_dir as '/home/oracle/exp/';\n\n\n")])])])]),e._v(" "),s("li",[s("p",[e._v("expdp nohi/nohi@orcl  schemas=riskDIRECTORY=data_dump_dir dumpfile=EXPDP_20171208.dmp LOGFILE=expdb.log version='10.2.0'")]),e._v(" "),s("ul",[s("li",[e._v("version 指定导入版本，向下兼容")])])]),e._v(" "),s("li",[s("p",[e._v("impdp  nohi/nohi@orcl DIRECTORY=data_dump_dir REMAP_SCHEMA=UserA:UserB remap_tablespace=TbsA:TbsB  DUMPFILE=EXPDP_20171208.dmp LOGFILE =impdb.log  version='10.2.0'")])])])])]),e._v(" "),s("h2",{attrs:{id:"常用语句"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常用语句","aria-hidden":"true"}},[e._v("#")]),e._v(" 常用语句")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("\n\nselect d.dbid            dbid\n     , d.name            db_name\n     , i.instance_number inst_num\n     , i.instance_name   inst_name\n  from v$database d,\n       v$instance i;\n    \n\n-- 表分析\nanalyze table tableName compute statistics;\nanalyze index indexname compute statistics;\n\n\n\n--- # 查看1小时内执行的sql语句，并按照执行时间倒序排序\nselect s.LAST_ACTIVE_TIME,s.SQL_TEXT,s.SQL_FULLTEXT,s.FIRST_LOAD_TIME,s.LAST_LOAD_TIME,s.EXECUTIONS from v$sql s\nwhere  s.LAST_ACTIVE_TIME>sysdate-1/24\n and s.PARSING_SCHEMA_NAME in ('CURVAPP', 'BASEAPP')\norder by s.LAST_ACTIVE_TIME desc;\n-- 超时时间\n-- 其中IDLE_TIME的值就是设置的空闲超时时间\nselect * from dba_profiles t where t.resource_name='CONNECT_TIME';\nselect * from user_resource_limits;\nselect resource_name,resource_type,limit from dba_profiles where profile='DEFAULT' ;\nALTER PROFILE DEFAULT LIMIT IDLE_TIME UNLIMITED;\n\nselect * from dba_profiles where profile='DEFAULT' ;\n\n-- 临时表空间\ncreate temporary tablespace temp tempfile '/opt/oracle/oradata/conner/temp.dbf' size 200M autoextend off;\nalter database default temporary tablespace temp;\ndrop tablespace temp2; //drop tablespace temp including contents and datafiles cascade constraints --彻底删除包括操作系统中的临时表空间的数据文件\n-- 表记录数\nselect * from user_tables where num_rows > 100000;\nselect num_rows * avg_row_len , table_name , num_rows from user_tables where num_rows > 10000 order by num_rows desc;\n  \n-- 查询表占用大小\nselect segment_name,bytes , bytes/1024/1024 M from user_segments where segment_type = 'TABLE' and segment_name not like 'BIN%' order by bytes desc\n  \nselect 'create sequence '||sequence_name||\n   ' minvalue '||min_value||\n   ' maxvalue '||max_value||\n   ' start with '||last_number||\n   ' increment by '||increment_by||\n   (case when cache_size=0 then ' nocache' else ' cache '||cache_size end) ||';'\nfrom user_sequences\n--    \nselect * from dba_users;\nselect * from user_tables;\nselect * from dba_data_files; \n")])])])])}],!1,null,null,null);a.default=t.exports}}]);